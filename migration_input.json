{
  "project_id": "upbsldljfejaieuveknr",
  "name": "add_multi_tenant_support",
  "query": "-- Extensões necessárias\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\n\n-- Tabela de clínicas (multi-tenant)\nCREATE TABLE IF NOT EXISTS clinicas (\n  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,\n  nome VARCHAR(255) NOT NULL,\n  cnpj VARCHAR(18) UNIQUE,\n  endereco TEXT,\n  telefone VARCHAR(20),\n  email VARCHAR(255),\n  plano VARCHAR(20) CHECK (plano IN ('individual', 'clinica')) NOT NULL DEFAULT 'individual',\n  status VARCHAR(20) CHECK (status IN ('trial', 'active', 'suspended', 'cancelled')) DEFAULT 'trial',\n  trial_ends_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '15 days'),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Adicionar colunas para suporte multi-tenant nas tabelas existentes\nALTER TABLE usuarios ADD COLUMN IF NOT EXISTS auth_user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;\nALTER TABLE usuarios ADD COLUMN IF NOT EXISTS clinic_id UUID REFERENCES clinicas(id) ON DELETE CASCADE;\nALTER TABLE usuarios ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(255);\nALTER TABLE usuarios ADD COLUMN IF NOT EXISTS ativo BOOLEAN DEFAULT true;\nALTER TABLE usuarios ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();\n\nALTER TABLE pacientes ADD COLUMN IF NOT EXISTS clinic_id UUID REFERENCES clinicas(id) ON DELETE CASCADE;\n\n-- Função para atualizar updated_at\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\n-- Triggers para updated_at\nDROP TRIGGER IF EXISTS update_usuarios_updated_at ON usuarios;\nCREATE TRIGGER update_usuarios_updated_at BEFORE UPDATE ON usuarios\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nDROP TRIGGER IF EXISTS update_clinicas_updated_at ON clinicas;\nCREATE TRIGGER update_clinicas_updated_at BEFORE UPDATE ON clinicas\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();"
}
